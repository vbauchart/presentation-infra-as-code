<!DOCTYPE html>
<html>

<head>
  <title>Pr√©sentation Infra As Code</title>
  <meta charset="utf-8">
  <style>
    @import url(https://fonts.googleapis.com/css?family=Open+Sans);
    @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
    @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);
  
    body {
      font-family: 'Open Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
    }

    .remark-slide-content h1 {
      font-weight: 300;
      font-size: 40px;
      color: rgb(103, 103, 103);
      padding-bottom: 10px;
      border-bottom: 1px solid green;
      font-variant: small-caps;
    }

    .remark-slide-content h2 {
      font-weight: 300;
      font-weight: 600;
      font-size: 25px;
      color: rgb(0, 124, 0);
      margin-bottom: 5px;
      margin-top: 20px;
    }

    .remark-slide-content h3 {
      margin-left: 10%;
      font-weight: 300;
      font-size: 25px;
      color: darkgreen;
      display: list-item;
      margin-bottom: 2px;
      margin-top: 2px;
    }

    /* slide-frontpage {
          font-family: 'Yanone Kaffeesatz';
          font-weight: 400;
          margin-bottom: 0;
          color: green;
          text-shadow: 2px 4px black;
        } */

    /* #slide-how .slides {
          font-size: 0.9em;
          position: absolute;
          top:  151px;
          right: 140px;
        }
        #slide-how .slides h3 {
          margin-top: 0.2em;
        }
        #slide-how .slides .first, #slide-how .slides .second {
          padding: 1px 20px;
          height: 90px;
          width: 120px;
          -moz-box-shadow: 0 0 10px #777;
          -webkit-box-shadow: 0 0 10px #777;
          box-shadow: 0 0 10px #777;
        }
        #slide-how .slides .first {
          background: #fff;
          position: absolute;
          top: 20%;
          left: 20%;
          z-index: 1;
        }
        #slide-how .slides .second {
          position: relative;
          background: #fff;
          z-index: 0;
        } */

    
    .image-flash img {
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
    }

    /* Two-column layout */
    .left-column {
      color: grey;
      width: 20%;
      height: 92%;
      float: left;
    }

    .left-column h2:last-of-type,
    .left-column h3:last-child {
      color: green;
    }

    .right-column {
      width: 75%;
      float: right;
      padding-top: 1em;
    }


    /* blockquote::before {
      content: open-quote;
      margin-right: 5px;
      font-size: 1.2em;
    } */

    blockquote {
      border-left: 0.3em solid #ccc;
      padding: 0 15px;
      font-style: italic;
      color: #7d7d7d;
    }

    /* blockquote::after {
      content: close-quote;
      margin-left: 5px;
      font-size: 1.2em;
    } */


    div.my-header {
      background: -webkit-gradient(linear, left top, right top, color-stop(0%, #f1ffee), color-stop(100%, green));
      position: fixed;
      top: 0px;
      left: 0px;
      height: 30px;
      width: 100%;
      text-align: left;
    }

    div.my-footer {
      border-top: 1px solid green;
      color: green;
      font-size: 10pt;
      text-align: center;
      position: fixed;
      bottom: 0px;
      left: 0px;
      height: 40px;
      width: 100%;
    }

    div.my-header img {
      height: 10%;
      top: 30px;
      right: 0px;
      position: fixed;
    }

    div.my-footer p {
      margin-top: 10px;
      height: 30px;
    }

    div.my-footer img {
      height: 20%;
      bottom: 0px;
      left: 0px;
      position: fixed;
    }
  </style>
  </head>

<body>
  <textarea id="source">
background-image: url(img/arolla-backgroud.jpg)
---
layout: true
name: with-logo
<div class="my-header"><img src="img/logo-arolla.png" /></div>
<div class="my-footer"><img src="img/dd-man.png" /><p>&copy; 2023 Arolla</p></div>

---
layout: false
class: center, middle
template: with-logo

# Petit sondage
---
template: with-logo

# Sondage

## Qui a d√©j√† entendu parler d'Infra As Code ?
--

### Git

### Docker

### Ansible

### Puppet

### Terraform

[//]: #######################################################################
[//]: #######################################################################
---
layout: false
class: center, middle
template: with-logo


# Probl√©matiques par l'exemple

[//]: #######################################################################
---
layout: true
template: with-logo

# Probl√©matiques

[//]: #######################################################################
---

## Il faut mettre √† jour la configuration SSH sur les 2000 serveurs

### Je me connecte √† tous les serveurs un par un ü§¶
--

### J'utilise un script Bash qui appelle un sed en SSH dans une boucle `for` ü§®

[//]: #######################################################################
---
## Les √©quipes de tests me demandent de cr√©er un environnement identique √† la production pour tester de bout en bout

### Je fais une demande des 16 serveurs n√©cessaires et je configure tout √† la main üò∞



[//]: #######################################################################
---
## Mon site est victime de son succ√®s, il faut passer de 2 √† 10 serveurs Web

### Je fais une demande pour 8 nouvelles VMs üïë


### J'installe et configure les 8 VMs üòÆ‚Äçüí®


### Je d√©clare les nouvelles machines dans le load-balance

--
### Je ne trouve pas la documentation

--
### Une fois termin√© le site renvoie une erreur une fois sur 10 üò∞

--
### C'est la panique, je passe la nuit √† trouver la virgule en trop qui fait tout planter üôÉ

--
### C'est toujours la panique, car j'ai oublier de monitorer les 8 nouvelles machines et une des VM a un probl√®me

[//]: #######################################################################
---
layout: false
class: center, middle
template: with-logo

# Premi√®res pistes


[//]: #######################################################################
---
layout: false
template: with-logo

# La cible üéØ

## Ne plus faire √† la main les t√¢ches r√©p√©titives

## Ne pas d√©pendre d'autres √©quipes

## Am√©liorer la confiance

## Augmenter la vitesse

[//]: #######################################################################
---
layout: false
template: with-logo

# La m√©thode ‚öôÔ∏è

## La solution tiens en 3 √©tapes :
--

### Automatiser
--

### Automatiser
--

### Automatiser

.right[![You got it](img/yougotit.gif)]



[//]: #######################################################################
[//]: #######################################################################
---
layout: false
class: center, middle
template: with-logo

# Automatisation ?

[//]: #######################################################################
---
layout: true
template: with-logo

# "`Infra As Code`"

[//]: #######################################################################
---
## ü§ñ Utiliser un langage de programmation

### Choisir le langage adapt√©

### Choisir le bon outil

## üö© Versionner

### Ajouter des point de sauvegarde

### Exp√©rimenter

## üé†Tester

### Reproduire ce qu'il va se passer

### V√©rifier les situations sp√©cifiques

[//]: #######################################################################
---
## Mon site est victime de son succ√®s, il faut passer de 2 √† 10 serveurs Web

### Validation sur l'environnement de test
```sh
$ git checkout develop                   # branche principale de dev
$ git checkout -b upgrade-servers        # cr√©er branche de test
$ vim application/web/servers.yml        # modifie la config
$ git commit -am'upgrade to 10 servers'  # ajoute message pertinent
$ git push                               # la CI/CD prend le relais
```

--
### Mise en production

```sh
$ git checkout master                    # branche de release
$ git merge upgrade-servers              # merge ce qui a √©t√© test√©
$ git push                               # la CI/CD prend le relais
```


[//]: #######################################################################
---
## Dans cette pr√©sentation, nous allons voir les outils suivants :

## 1. Les gestionnaires de configuration

### Puppet

### Ansible

### *Docker*

## 2. Les provisionneurs

### Terraform

### *Ansible*

## 3. Les orchestrateurs

### Kubernetes

### *Ansible*


[//]: #######################################################################
[//]: #######################################################################
---
layout: false
class: center, middle
template: with-logo

# Les gestionnaires de configuration


[//]: #######################################################################
---
layout: true
template: with-logo

# Les gestionnaires de configuration
---

## S'execute sur une machine en fonctionnement

### Installe des packages

### Cr√©er des users/groups/r√©pertoires

### Cr√©er des fichiers de configuration

### Lance des commandes de configuration

### ...


[//]: #######################################################################

---

## Exemple installation de SSH sur Debian :

### Installe le paquet `apt install openssh-server`

### G√©n√®re les clefs du serveur par `ssh-keygen -A`

### Adapter le fichier `/etc/ssh/sshd_config` √† nos besoins

### Ajouter un utilisateur

### Red√©marrer le d√©mon ssh

--
## üëâ Un script shell semble pouvoir faire l'affaire !! üëà


[//]: #######################################################################
---

## Un script shell par produit

### probl√®me r√©solu üòé

```script
#!/bin/bash -xe

apt install -y openssh-server

ssh-keygen -A

sed 's/^PermitEmptyPasswords yes/PermitEmptyPasswords no/' /etc/ssh/sshd_config
sed 's/^PermitRootLogin no/PermitRootLogin prohibit-password/' /etc/ssh/sshd_config

useradd -m user1

systemctl restart sshd
```

--
.image-flash[![Objection](img/objection.gif)]



[//]: #######################################################################
---

## Probl√®mes √† g√©rer:

### Comment g√©rer un parc h√©t√©rog√®ne (Debian, Redhat, ...) ?

### Comment g√©rer l'installation **et/ou** la mise √† jour ?

### Que se passe-t-il si le serveur n'est pas dans l'√©tat pr√©vu ?

### Comment savoir quels logiciels installer selon le role de la machine ?

### Comment permettre d'avoir plusieurs instances de l'application avec des param√®tres differents ?



[//]: #######################################################################
---

## *Petite pause vocabulaire !*

## Idempotence en math√©matique

### une fonction a le r√©sultat qu'on l'applique une ou plusieurs fois

### Par exemple :

```math
abs(abs(x)) = abs(x)
abs(abs(-5)) = abs(-5) = 5
```

[//]: #######################################################################
---

## Idempotence pour de la configuration :

### Une op√©ration a le m√™me effet qu'on l'applique une ou plusieurs fois

--

## Sur l'exemple pr√©cedent du script Bash :

```bash
# Indempotent
apt install -y openssh-server
```

--
```bash
# PAS indempotent
useradd -m user1
```

--
```bash
# Indempotent (si le fichier n'a pas √©t√© modif√© par ailleurs)
sed 's/^PermitEmptyPasswords yes/PermitEmptyPasswords no/' /etc/ssh/sshd_config
```

[//]: #######################################################################
---

## Pourquoi la notion d'_idempotence_ stricte est importante pour un gestionnaire de configuration ?

### On veut g√©rer la mise √† jour d'un parc de serveurs quelque soit leur √©tat initial

### On veut g√©rer le cas d'une mise √† jour arr√™t√©e brusquement

### La mise √† jour ne doit pas √™tre sensible √† une intervention manuelle

### On veut v√©rifier tous les attributs d'un √©l√©ment, pas seulement son existence


[//]: #######################################################################
---

## Probl√®mes √† g√©rer:

### Comment g√©rer un parc h√©t√©rog√®ne (Debian, Redhat, ...) ?

### ~~Comment g√©rer l'installation **et/ou** la mise √† jour~~

### ~~Que se passe-t-il si le serveur n'est pas dans l'√©tat pr√©vu ?~~

### **Comment assurer l‚Äôidempotence**

### Comment savoir quels logiciels installer selon le role de la machine ?

### Comment permettre d'avoir plusieurs instances de l'application avec des param√®tres differents ?


[//]: #######################################################################
---

## Les principaux gestionnaires de configuration traditionnels :

### **Ansible**

### **Puppet**

### Chef

### Salt

### üëâ https://en.wikipedia.org/wiki/Comparison_of_open-source_configuration_management_software

## Un gestionnaire de configuration un peu sp√©cial :

### Docker

[//]: #######################################################################
[//]: #######################################################################
---
layout: false
class: center, middle
template: with-logo

# Ansible

[//]: #######################################################################
---
layout: true
template: with-logo

# Ansible

[//]: #######################################################################
---

## Mode d'installation du client (`Control Node`)

### Le framework Ansible

### La clef priv√©e SSH

### Les fichiers de description dans GIT

## Mode d'installation des serveurs supervis√©s (`Managed Nodes`)

### Python (dans une version [suffisamment r√©cente](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#node-requirement-summary))

### Un utilisateur poss√©dant la clef publique SSH

### Cet utilisateur doit avoir suffisamment de droit sur le syst√®me (ex: `sudo`)

> On notera le peu de pr√©requis n√©cessaires, en particulier sur les serveurs supervis√©s

[//]: #######################################################################
---

## Mode de fonctionnement

### On d√©crit les groupes de **`nodes`** et leurs param√©trages dans un **`inventory`**

### On execute un **`playbook`** sur un un groupe de serveurs de l'**`inventory`**

### Un **`playbook`** est un fichier YAML constitu√© d'une liste de **`tasks`**

### Une **`task`** appel un **`module`** avec des param√®tres

### Un **`module`** est un morceau de code (g√©n√©ralement Python) permettant de g√©rer un √©l√©ment du **`nodes`** de fa√ßon idempotente

### Il est possible de regrouper des **`tasks`** dans un **`role`**

[//]: #######################################################################
---

## R√©sum√©

.center[<div class="mermaid">
  flowchart TB

  subgraph nodes
  Inventory --> Group1
  Inventory --> Group2
  Group1 --> Node1
  Group1 --> Node2
  Group2 --> Node2
  Group2 --> Node3
  end

  subgraph tasks
  Playbook --> tasks1
  Playbook --> tasks2
  Playbook --> role1
  Playbook --> role2
  role1    --> task4
  role1    --> task5
  role2    --> task7
  role2    --> task8
  end

  Playbook -.-> Group1
</div>]

[//]: #######################################################################
---

## Exemples de **`tasks`**

### Module `package`
```YAML
- name: Install a list of packages
  ansible.builtin.package:
    pkg:
    - foo
    - foo-tools
```

### Module `user`

```YAML
- name: Add the user 'johnd' with an uid and a primary group of 'admin'
  ansible.builtin.user:
    name: johnd
    comment: John Doe
    uid: 1040
    group: admin
```

[//]: #######################################################################
---

## Exemples de **`tasks`**


























[//]: #######################################################################

    </textarea>
  <script src="https://remarkjs.com/downloads/remark-latest.min.js">
  </script>
  <script>
    var slideshow = remark.create({
  highlightLanguage: 'javascript',
  highlightStyle: 'monokai',
  highlightLines: true,
  highlightSpans: true
    });
  </script>
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    // mermaid.initialize({ startOnLoad: true });
    mermaid.initialize({
      startOnLoad: false,
      cloneCssStyles: false
    });
    function initMermaid(s) {
      var diagrams = document.querySelectorAll('.mermaid');
      var i;
      for(i=0;i<diagrams.length;i++){
        if(diagrams[i].offsetWidth>0){
          mermaid.init(undefined, diagrams[i]);
        }
      }
    }
    slideshow.on('afterShowSlide', initMermaid);
    initMermaid(slideshow.getSlides()[slideshow.getCurrentSlideIndex()]);
  </script>

</html>